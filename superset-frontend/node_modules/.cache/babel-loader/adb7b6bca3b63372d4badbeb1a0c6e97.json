{"ast":null,"code":"import _extends from \"@babel/runtime-corejs3/helpers/extends\";var _jsxFileName = \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/components/controls/DateFilterControl/DateFilterLabel.tsx\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, { useState, useEffect, useMemo } from 'react';\nimport rison from 'rison';\nimport { SupersetClient, styled, t, useTheme } from '@superset-ui/core';\nimport { buildTimeRangeString, formatTimeRange, COMMON_RANGE_VALUES_SET, CALENDAR_RANGE_VALUES_SET, FRAME_OPTIONS, customTimeRangeDecode } from 'src/explore/components/controls/DateFilterControl/utils';\nimport { getClientErrorObject } from 'src/utils/getClientErrorObject';\nimport Button from 'src/components/Button';\nimport ControlHeader from 'src/explore/components/ControlHeader';\nimport Label from 'src/components/Label';\nimport Popover from 'src/components/Popover';\nimport { Divider } from 'src/common/components';\nimport Icons from 'src/components/Icons';\nimport { Select } from 'src/components';\nimport { Tooltip } from 'src/components/Tooltip';\nimport { DEFAULT_TIME_RANGE } from 'src/explore/constants';\nimport { useDebouncedEffect } from 'src/explore/exploreUtils';\nimport { SLOW_DEBOUNCE } from 'src/constants';\nimport { testWithId } from 'src/utils/testUtils';\nimport { CommonFrame, CalendarFrame, CustomFrame, AdvancedFrame } from './components';import { jsx as ___EmotionJSX } from \"@emotion/react\";\nconst guessFrame = (timeRange) => {\n  if (COMMON_RANGE_VALUES_SET.has(timeRange)) {\n    return 'Common';\n  }\n  if (CALENDAR_RANGE_VALUES_SET.has(timeRange)) {\n    return 'Calendar';\n  }\n  if (timeRange === 'No filter') {\n    return 'No filter';\n  }\n  if (customTimeRangeDecode(timeRange).matchedFlag) {\n    return 'Custom';\n  }\n  return 'Advanced';\n};\nconst fetchTimeRange = async (timeRange, endpoints) => {\n  const query = rison.encode(timeRange);\n  const endpoint = `/api/v1/time_range/?q=${query}`;\n  try {var _response$json, _response$json$result, _response$json2, _response$json2$resul;\n    const response = await SupersetClient.get({ endpoint });\n    const timeRangeString = buildTimeRangeString((response == null ? void 0 : (_response$json = response.json) == null ? void 0 : (_response$json$result = _response$json.result) == null ? void 0 : _response$json$result.since) || '', (response == null ? void 0 : (_response$json2 = response.json) == null ? void 0 : (_response$json2$resul = _response$json2.result) == null ? void 0 : _response$json2$resul.until) || '');\n    return {\n      value: formatTimeRange(timeRangeString, endpoints) };\n\n  }\n  catch (response) {\n    const clientError = await getClientErrorObject(response);\n    return {\n      error: clientError.message || clientError.error };\n\n  }\n};\nconst StyledPopover = styled(Popover)``;\nconst StyledRangeType = styled(Select)`\n  width: 272px;\n`;\nconst ContentStyleWrapper = styled.div`\n  .ant-row {\n    margin-top: 8px;\n  }\n\n  .ant-input-number {\n    width: 100%;\n  }\n\n  .ant-picker {\n    padding: 4px 17px 4px;\n    border-radius: 4px;\n    width: 100%;\n  }\n\n  .ant-divider-horizontal {\n    margin: 16px 0;\n  }\n\n  .control-label {\n    font-size: 11px;\n    font-weight: 500;\n    color: #b2b2b2;\n    line-height: 16px;\n    text-transform: uppercase;\n    margin: 8px 0;\n  }\n\n  .vertical-radio {\n    display: block;\n    height: 40px;\n    line-height: 40px;\n  }\n\n  .section-title {\n    font-style: normal;\n    font-weight: 500;\n    font-size: 15px;\n    line-height: 24px;\n    margin-bottom: 8px;\n  }\n\n  .control-anchor-to {\n    margin-top: 16px;\n  }\n\n  .control-anchor-to-datetime {\n    width: 217px;\n  }\n\n  .footer {\n    text-align: right;\n  }\n`;\nconst IconWrapper = styled.span`\n  span {\n    margin-right: ${({ theme }) => 2 * theme.gridUnit}px;\n    vertical-align: middle;\n  }\n  .text {\n    vertical-align: middle;\n  }\n  .error {\n    color: ${({ theme }) => theme.colors.error.base};\n  }\n`;\nexport const DATE_FILTER_CONTROL_TEST_ID = 'date-filter-control';\nexport const getDateFilterControlTestId = testWithId(DATE_FILTER_CONTROL_TEST_ID);\nexport default function DateFilterLabel(props) {\n  const { value = DEFAULT_TIME_RANGE, endpoints, onChange, type } = props;\n  const [actualTimeRange, setActualTimeRange] = useState(value);\n  const [show, setShow] = useState(false);\n  const guessedFrame = useMemo(() => guessFrame(value), [value]);\n  const [frame, setFrame] = useState(guessedFrame);\n  const [lastFetchedTimeRange, setLastFetchedTimeRange] = useState(value);\n  const [timeRangeValue, setTimeRangeValue] = useState(value);\n  const [validTimeRange, setValidTimeRange] = useState(false);\n  const [evalResponse, setEvalResponse] = useState(value);\n  const [tooltipTitle, setTooltipTitle] = useState(value);\n  useEffect(() => {\n    fetchTimeRange(value, endpoints).then(({ value: actualRange, error }) => {\n      if (error) {\n        setEvalResponse(error || '');\n        setValidTimeRange(false);\n        setTooltipTitle(value || '');\n      } else\n      {\n        /*\n          HRT == human readable text\n          ADR == actual datetime range\n          +--------------+------+----------+--------+----------+-----------+\n          |              | Last | Previous | Custom | Advanced | No Filter |\n          +--------------+------+----------+--------+----------+-----------+\n          | control pill | HRT  | HRT      | ADR    | ADR      |   HRT     |\n          +--------------+------+----------+--------+----------+-----------+\n          | tooltip      | ADR  | ADR      | HRT    | HRT      |   ADR     |\n          +--------------+------+----------+--------+----------+-----------+\n        */\n        if (guessedFrame === 'Common' ||\n        guessedFrame === 'Calendar' ||\n        guessedFrame === 'No filter') {\n          setActualTimeRange(value);\n          setTooltipTitle(type === 'error' ?\n          t('Default value is required') :\n          actualRange || '');\n        } else\n        {\n          setActualTimeRange(actualRange || '');\n          setTooltipTitle(value || '');\n        }\n        setValidTimeRange(true);\n      }\n      setLastFetchedTimeRange(value);\n    });\n  }, [value]);\n  useDebouncedEffect(() => {\n    if (lastFetchedTimeRange !== timeRangeValue) {\n      fetchTimeRange(timeRangeValue, endpoints).then(({ value: actualRange, error }) => {\n        if (error) {\n          setEvalResponse(error || '');\n          setValidTimeRange(false);\n        } else\n        {\n          setEvalResponse(actualRange || '');\n          setValidTimeRange(true);\n        }\n        setLastFetchedTimeRange(timeRangeValue);\n      });\n    }\n  }, SLOW_DEBOUNCE, [timeRangeValue]);\n  function onSave() {\n    onChange(timeRangeValue);\n    setShow(false);\n  }\n  function onOpen() {\n    setTimeRangeValue(value);\n    setFrame(guessedFrame);\n    setShow(true);\n  }\n  function onHide() {\n    setTimeRangeValue(value);\n    setFrame(guessedFrame);\n    setShow(false);\n  }\n  const togglePopover = () => {\n    if (show) {\n      onHide();\n    } else\n    {\n      setShow(true);\n    }\n  };\n  function onChangeFrame(value) {\n    if (value === 'No filter') {\n      setTimeRangeValue('No filter');\n    }\n    setFrame(value);\n  }\n  const theme = useTheme();\n  const overlayContent = ___EmotionJSX(ContentStyleWrapper, { __self: this, __source: { fileName: _jsxFileName, lineNumber: 232, columnNumber: 29 } },\n  ___EmotionJSX(\"div\", { className: \"control-label\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 233, columnNumber: 7 } }, t('RANGE TYPE')),\n  ___EmotionJSX(StyledRangeType, { ariaLabel: t('RANGE TYPE'), options: FRAME_OPTIONS, value: frame, onChange: onChangeFrame, __self: this, __source: { fileName: _jsxFileName, lineNumber: 234, columnNumber: 7 } }),\n  frame !== 'No filter' && ___EmotionJSX(Divider, { __self: this, __source: { fileName: _jsxFileName, lineNumber: 235, columnNumber: 33 } }),\n  frame === 'Common' && ___EmotionJSX(CommonFrame, { value: timeRangeValue, onChange: setTimeRangeValue, __self: this, __source: { fileName: _jsxFileName, lineNumber: 236, columnNumber: 31 } }),\n  frame === 'Calendar' && ___EmotionJSX(CalendarFrame, { value: timeRangeValue, onChange: setTimeRangeValue, __self: this, __source: { fileName: _jsxFileName, lineNumber: 237, columnNumber: 33 } }),\n  frame === 'Advanced' && ___EmotionJSX(AdvancedFrame, { value: timeRangeValue, onChange: setTimeRangeValue, __self: this, __source: { fileName: _jsxFileName, lineNumber: 238, columnNumber: 33 } }),\n  frame === 'Custom' && ___EmotionJSX(CustomFrame, { value: timeRangeValue, onChange: setTimeRangeValue, __self: this, __source: { fileName: _jsxFileName, lineNumber: 239, columnNumber: 31 } }),\n  frame === 'No filter' && ___EmotionJSX(\"div\", { \"data-test\": \"no-filter\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 240, columnNumber: 33 } }),\n  ___EmotionJSX(Divider, { __self: this, __source: { fileName: _jsxFileName, lineNumber: 241, columnNumber: 7 } }),\n  ___EmotionJSX(\"div\", { __self: this, __source: { fileName: _jsxFileName, lineNumber: 242, columnNumber: 7 } },\n  ___EmotionJSX(\"div\", { className: \"section-title\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 243, columnNumber: 9 } }, t('Actual time range')),\n  validTimeRange && ___EmotionJSX(\"div\", { __self: this, __source: { fileName: _jsxFileName, lineNumber: 244, columnNumber: 28 } }, evalResponse),\n  !validTimeRange && ___EmotionJSX(IconWrapper, { className: \"warning\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 245, columnNumber: 30 } },\n  ___EmotionJSX(Icons.ErrorSolidSmall, { iconColor: theme.colors.error.base, __self: this, __source: { fileName: _jsxFileName, lineNumber: 246, columnNumber: 13 } }),\n  ___EmotionJSX(\"span\", { className: \"text error\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 247, columnNumber: 13 } }, evalResponse))),\n\n\n  ___EmotionJSX(Divider, { __self: this, __source: { fileName: _jsxFileName, lineNumber: 250, columnNumber: 7 } }),\n  ___EmotionJSX(\"div\", { className: \"footer\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 251, columnNumber: 7 } },\n  ___EmotionJSX(Button, { buttonStyle: \"secondary\", cta: true, key: \"cancel\", onClick: onHide, \"data-test\": \"cancel-button\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 252, columnNumber: 9 } },\n  t('CANCEL')),\n\n  ___EmotionJSX(Button, _extends({ buttonStyle: \"primary\", cta: true, disabled: !validTimeRange, key: \"apply\", onClick: onSave }, getDateFilterControlTestId('apply-button'), { __self: this, __source: { fileName: _jsxFileName, lineNumber: 255, columnNumber: 9 } }),\n  t('APPLY'))));\n\n\n\n  const title = ___EmotionJSX(IconWrapper, { __self: this, __source: { fileName: _jsxFileName, lineNumber: 260, columnNumber: 20 } },\n  ___EmotionJSX(Icons.EditAlt, { iconColor: theme.colors.grayscale.base, __self: this, __source: { fileName: _jsxFileName, lineNumber: 261, columnNumber: 7 } }),\n  ___EmotionJSX(\"span\", { className: \"text\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 262, columnNumber: 7 } }, t('Edit time range')));\n\n  const overlayStyle = {\n    width: '600px' };\n\n  return ___EmotionJSX(React.Fragment, null,\n  ___EmotionJSX(ControlHeader, _extends({}, props, { __self: this, __source: { fileName: _jsxFileName, lineNumber: 268, columnNumber: 7 } })),\n  ___EmotionJSX(StyledPopover, { placement: \"right\", trigger: \"click\", content: overlayContent, title: title, defaultVisible: show, visible: show, onVisibleChange: togglePopover, overlayStyle: overlayStyle, __self: this, __source: { fileName: _jsxFileName, lineNumber: 269, columnNumber: 7 } },\n  ___EmotionJSX(Tooltip, { placement: \"top\", title: tooltipTitle, __self: this, __source: { fileName: _jsxFileName, lineNumber: 270, columnNumber: 9 } },\n  ___EmotionJSX(Label, { className: \"pointer\", \"data-test\": \"time-range-trigger\", onClick: onOpen, __self: this, __source: { fileName: _jsxFileName, lineNumber: 271, columnNumber: 11 } },\n  actualTimeRange))));\n\n\n\n\n}__signature__(DateFilterLabel, \"useState{[actualTimeRange, setActualTimeRange](value)}\\nuseState{[show, setShow](false)}\\nuseMemo{guessedFrame}\\nuseState{[frame, setFrame](guessedFrame)}\\nuseState{[lastFetchedTimeRange, setLastFetchedTimeRange](value)}\\nuseState{[timeRangeValue, setTimeRangeValue](value)}\\nuseState{[validTimeRange, setValidTimeRange](false)}\\nuseState{[evalResponse, setEvalResponse](value)}\\nuseState{[tooltipTitle, setTooltipTitle](value)}\\nuseEffect{}\\nuseDebouncedEffect{}\\nuseTheme{theme}\", () => [useDebouncedEffect, useTheme]);;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(guessFrame, \"guessFrame\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/components/controls/DateFilterControl/DateFilterLabel.tsx\");reactHotLoader.register(fetchTimeRange, \"fetchTimeRange\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/components/controls/DateFilterControl/DateFilterLabel.tsx\");reactHotLoader.register(StyledPopover, \"StyledPopover\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/components/controls/DateFilterControl/DateFilterLabel.tsx\");reactHotLoader.register(StyledRangeType, \"StyledRangeType\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/components/controls/DateFilterControl/DateFilterLabel.tsx\");reactHotLoader.register(ContentStyleWrapper, \"ContentStyleWrapper\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/components/controls/DateFilterControl/DateFilterLabel.tsx\");reactHotLoader.register(IconWrapper, \"IconWrapper\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/components/controls/DateFilterControl/DateFilterLabel.tsx\");reactHotLoader.register(DATE_FILTER_CONTROL_TEST_ID, \"DATE_FILTER_CONTROL_TEST_ID\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/components/controls/DateFilterControl/DateFilterLabel.tsx\");reactHotLoader.register(getDateFilterControlTestId, \"getDateFilterControlTestId\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/components/controls/DateFilterControl/DateFilterLabel.tsx\");reactHotLoader.register(DateFilterLabel, \"DateFilterLabel\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/components/controls/DateFilterControl/DateFilterLabel.tsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/components/controls/DateFilterControl/DateFilterLabel.tsx"],"names":[],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, { useState, useEffect, useMemo } from 'react';\nimport rison from 'rison';\nimport {\n  SupersetClient,\n  styled,\n  t,\n  TimeRangeEndpoints,\n  useTheme,\n} from '@superset-ui/core';\nimport {\n  buildTimeRangeString,\n  formatTimeRange,\n  COMMON_RANGE_VALUES_SET,\n  CALENDAR_RANGE_VALUES_SET,\n  FRAME_OPTIONS,\n  customTimeRangeDecode,\n} from 'src/explore/components/controls/DateFilterControl/utils';\nimport { getClientErrorObject } from 'src/utils/getClientErrorObject';\nimport Button from 'src/components/Button';\nimport ControlHeader from 'src/explore/components/ControlHeader';\nimport Label, { Type } from 'src/components/Label';\nimport Popover from 'src/components/Popover';\nimport { Divider } from 'src/common/components';\nimport Icons from 'src/components/Icons';\nimport { Select } from 'src/components';\nimport { Tooltip } from 'src/components/Tooltip';\nimport { DEFAULT_TIME_RANGE } from 'src/explore/constants';\nimport { useDebouncedEffect } from 'src/explore/exploreUtils';\nimport { SLOW_DEBOUNCE } from 'src/constants';\nimport { testWithId } from 'src/utils/testUtils';\nimport { FrameType } from './types';\n\nimport {\n  CommonFrame,\n  CalendarFrame,\n  CustomFrame,\n  AdvancedFrame,\n} from './components';\n\nconst guessFrame = (timeRange: string): FrameType => {\n  if (COMMON_RANGE_VALUES_SET.has(timeRange)) {\n    return 'Common';\n  }\n  if (CALENDAR_RANGE_VALUES_SET.has(timeRange)) {\n    return 'Calendar';\n  }\n  if (timeRange === 'No filter') {\n    return 'No filter';\n  }\n  if (customTimeRangeDecode(timeRange).matchedFlag) {\n    return 'Custom';\n  }\n  return 'Advanced';\n};\n\nconst fetchTimeRange = async (\n  timeRange: string,\n  endpoints?: TimeRangeEndpoints,\n) => {\n  const query = rison.encode(timeRange);\n  const endpoint = `/api/v1/time_range/?q=${query}`;\n  try {\n    const response = await SupersetClient.get({ endpoint });\n    const timeRangeString = buildTimeRangeString(\n      response?.json?.result?.since || '',\n      response?.json?.result?.until || '',\n    );\n    return {\n      value: formatTimeRange(timeRangeString, endpoints),\n    };\n  } catch (response) {\n    const clientError = await getClientErrorObject(response);\n    return {\n      error: clientError.message || clientError.error,\n    };\n  }\n};\n\nconst StyledPopover = styled(Popover)``;\nconst StyledRangeType = styled(Select)`\n  width: 272px;\n`;\n\nconst ContentStyleWrapper = styled.div`\n  .ant-row {\n    margin-top: 8px;\n  }\n\n  .ant-input-number {\n    width: 100%;\n  }\n\n  .ant-picker {\n    padding: 4px 17px 4px;\n    border-radius: 4px;\n    width: 100%;\n  }\n\n  .ant-divider-horizontal {\n    margin: 16px 0;\n  }\n\n  .control-label {\n    font-size: 11px;\n    font-weight: 500;\n    color: #b2b2b2;\n    line-height: 16px;\n    text-transform: uppercase;\n    margin: 8px 0;\n  }\n\n  .vertical-radio {\n    display: block;\n    height: 40px;\n    line-height: 40px;\n  }\n\n  .section-title {\n    font-style: normal;\n    font-weight: 500;\n    font-size: 15px;\n    line-height: 24px;\n    margin-bottom: 8px;\n  }\n\n  .control-anchor-to {\n    margin-top: 16px;\n  }\n\n  .control-anchor-to-datetime {\n    width: 217px;\n  }\n\n  .footer {\n    text-align: right;\n  }\n`;\n\nconst IconWrapper = styled.span`\n  span {\n    margin-right: ${({ theme }) => 2 * theme.gridUnit}px;\n    vertical-align: middle;\n  }\n  .text {\n    vertical-align: middle;\n  }\n  .error {\n    color: ${({ theme }) => theme.colors.error.base};\n  }\n`;\n\ninterface DateFilterControlProps {\n  name: string;\n  onChange: (timeRange: string) => void;\n  value?: string;\n  endpoints?: TimeRangeEndpoints;\n  type?: Type;\n}\n\nexport const DATE_FILTER_CONTROL_TEST_ID = 'date-filter-control';\nexport const getDateFilterControlTestId = testWithId(\n  DATE_FILTER_CONTROL_TEST_ID,\n);\n\nexport default function DateFilterLabel(props: DateFilterControlProps) {\n  const { value = DEFAULT_TIME_RANGE, endpoints, onChange, type } = props;\n  const [actualTimeRange, setActualTimeRange] = useState<string>(value);\n\n  const [show, setShow] = useState<boolean>(false);\n  const guessedFrame = useMemo(() => guessFrame(value), [value]);\n  const [frame, setFrame] = useState<FrameType>(guessedFrame);\n  const [lastFetchedTimeRange, setLastFetchedTimeRange] = useState(value);\n  const [timeRangeValue, setTimeRangeValue] = useState(value);\n  const [validTimeRange, setValidTimeRange] = useState<boolean>(false);\n  const [evalResponse, setEvalResponse] = useState<string>(value);\n  const [tooltipTitle, setTooltipTitle] = useState<string>(value);\n\n  useEffect(() => {\n    fetchTimeRange(value, endpoints).then(({ value: actualRange, error }) => {\n      if (error) {\n        setEvalResponse(error || '');\n        setValidTimeRange(false);\n        setTooltipTitle(value || '');\n      } else {\n        /*\n          HRT == human readable text\n          ADR == actual datetime range\n          +--------------+------+----------+--------+----------+-----------+\n          |              | Last | Previous | Custom | Advanced | No Filter |\n          +--------------+------+----------+--------+----------+-----------+\n          | control pill | HRT  | HRT      | ADR    | ADR      |   HRT     |\n          +--------------+------+----------+--------+----------+-----------+\n          | tooltip      | ADR  | ADR      | HRT    | HRT      |   ADR     |\n          +--------------+------+----------+--------+----------+-----------+\n        */\n        if (\n          guessedFrame === 'Common' ||\n          guessedFrame === 'Calendar' ||\n          guessedFrame === 'No filter'\n        ) {\n          setActualTimeRange(value);\n          setTooltipTitle(\n            type === ('error' as Type)\n              ? t('Default value is required')\n              : actualRange || '',\n          );\n        } else {\n          setActualTimeRange(actualRange || '');\n          setTooltipTitle(value || '');\n        }\n        setValidTimeRange(true);\n      }\n      setLastFetchedTimeRange(value);\n    });\n  }, [value]);\n\n  useDebouncedEffect(\n    () => {\n      if (lastFetchedTimeRange !== timeRangeValue) {\n        fetchTimeRange(timeRangeValue, endpoints).then(\n          ({ value: actualRange, error }) => {\n            if (error) {\n              setEvalResponse(error || '');\n              setValidTimeRange(false);\n            } else {\n              setEvalResponse(actualRange || '');\n              setValidTimeRange(true);\n            }\n            setLastFetchedTimeRange(timeRangeValue);\n          },\n        );\n      }\n    },\n    SLOW_DEBOUNCE,\n    [timeRangeValue],\n  );\n\n  function onSave() {\n    onChange(timeRangeValue);\n    setShow(false);\n  }\n\n  function onOpen() {\n    setTimeRangeValue(value);\n    setFrame(guessedFrame);\n    setShow(true);\n  }\n\n  function onHide() {\n    setTimeRangeValue(value);\n    setFrame(guessedFrame);\n    setShow(false);\n  }\n\n  const togglePopover = () => {\n    if (show) {\n      onHide();\n    } else {\n      setShow(true);\n    }\n  };\n\n  function onChangeFrame(value: string) {\n    if (value === 'No filter') {\n      setTimeRangeValue('No filter');\n    }\n    setFrame(value as FrameType);\n  }\n\n  const theme = useTheme();\n\n  const overlayContent = (\n    <ContentStyleWrapper>\n      <div className=\"control-label\">{t('RANGE TYPE')}</div>\n      <StyledRangeType\n        ariaLabel={t('RANGE TYPE')}\n        options={FRAME_OPTIONS}\n        value={frame}\n        onChange={onChangeFrame}\n      />\n      {frame !== 'No filter' && <Divider />}\n      {frame === 'Common' && (\n        <CommonFrame value={timeRangeValue} onChange={setTimeRangeValue} />\n      )}\n      {frame === 'Calendar' && (\n        <CalendarFrame value={timeRangeValue} onChange={setTimeRangeValue} />\n      )}\n      {frame === 'Advanced' && (\n        <AdvancedFrame value={timeRangeValue} onChange={setTimeRangeValue} />\n      )}\n      {frame === 'Custom' && (\n        <CustomFrame value={timeRangeValue} onChange={setTimeRangeValue} />\n      )}\n      {frame === 'No filter' && <div data-test=\"no-filter\" />}\n      <Divider />\n      <div>\n        <div className=\"section-title\">{t('Actual time range')}</div>\n        {validTimeRange && <div>{evalResponse}</div>}\n        {!validTimeRange && (\n          <IconWrapper className=\"warning\">\n            <Icons.ErrorSolidSmall iconColor={theme.colors.error.base} />\n            <span className=\"text error\">{evalResponse}</span>\n          </IconWrapper>\n        )}\n      </div>\n      <Divider />\n      <div className=\"footer\">\n        <Button\n          buttonStyle=\"secondary\"\n          cta\n          key=\"cancel\"\n          onClick={onHide}\n          data-test=\"cancel-button\"\n        >\n          {t('CANCEL')}\n        </Button>\n        <Button\n          buttonStyle=\"primary\"\n          cta\n          disabled={!validTimeRange}\n          key=\"apply\"\n          onClick={onSave}\n          {...getDateFilterControlTestId('apply-button')}\n        >\n          {t('APPLY')}\n        </Button>\n      </div>\n    </ContentStyleWrapper>\n  );\n\n  const title = (\n    <IconWrapper>\n      <Icons.EditAlt iconColor={theme.colors.grayscale.base} />\n      <span className=\"text\">{t('Edit time range')}</span>\n    </IconWrapper>\n  );\n\n  const overlayStyle = {\n    width: '600px',\n  };\n\n  return (\n    <>\n      <ControlHeader {...props} />\n      <StyledPopover\n        placement=\"right\"\n        trigger=\"click\"\n        content={overlayContent}\n        title={title}\n        defaultVisible={show}\n        visible={show}\n        onVisibleChange={togglePopover}\n        overlayStyle={overlayStyle}\n      >\n        <Tooltip placement=\"top\" title={tooltipTitle}>\n          <Label\n            className=\"pointer\"\n            data-test=\"time-range-trigger\"\n            onClick={onOpen}\n          >\n            {actualTimeRange}\n          </Label>\n        </Tooltip>\n      </StyledPopover>\n    </>\n  );\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}