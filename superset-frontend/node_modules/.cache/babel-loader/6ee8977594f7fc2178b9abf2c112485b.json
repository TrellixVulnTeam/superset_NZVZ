{"ast":null,"code":"(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();import \"core-js/modules/es.string.replace.js\";var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;};import _omit from \"lodash/omit\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();import \"core-js/modules/es.string.replace.js\";var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n* Licensed to the Apache Software Foundation (ASF) under one\n* or more contributor license agreements.  See the NOTICE file\n* distributed with this work for additional information\n* regarding copyright ownership.  The ASF licenses this file\n* to you under the Apache License, Version 2.0 (the\n* \"License\"); you may not use this file except in compliance\n* with the License.  You may obtain a copy of the License at\n*\n*   http://www.apache.org/licenses/LICENSE-2.0\n*\n* Unless required by applicable law or agreed to in writing,\n* software distributed under the License is distributed on an\n* \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n* KIND, either express or implied.  See the License for the\n* specific language governing permissions and limitations\n* under the License.\n*/\n\nimport { useCallback, useEffect } from 'react';\n\n/* eslint camelcase: 0 */\nimport URI from 'urijs';\nimport {\nbuildQueryContext,\nensureIsArray,\ngetChartBuildQueryRegistry,\ngetChartMetadataRegistry } from\n'@superset-ui/core';\nimport { availableDomains } from 'src/utils/hostNamesConfig';\nimport { safeStringify } from 'src/utils/safeStringify';\nimport { URL_PARAMS } from 'src/constants';\nimport {\nMULTI_OPERATORS,\nOPERATOR_ENUM_TO_OPERATOR_TYPE } from\n'src/explore/constants';\nimport { DashboardStandaloneMode } from 'src/dashboard/util/constants';\n\nconst MAX_URL_LENGTH = 8000;\n\nexport function getChartKey(explore) {\n  const { slice } = explore;\n  return slice ? slice.slice_id : 0;\n}\n\nlet requestCounter = 0;\nexport function getHostName(allowDomainSharding = false) {\n  let currentIndex = 0;\n  if (allowDomainSharding) {\n    currentIndex = requestCounter % availableDomains.length;\n    requestCounter += 1;\n\n    // if domain sharding is enabled, skip main domain for fetching chart API\n    // leave main domain free for other calls like fav star, save change, etc.\n    // to make dashboard be responsive when it's loading large number of charts\n    if (currentIndex === 0) {\n      currentIndex += 1;\n      requestCounter += 1;\n    }\n  }\n  return availableDomains[currentIndex];\n}\n\nexport function getAnnotationJsonUrl(slice_id, form_data, isNative, force) {\n  if (slice_id === null || slice_id === undefined) {\n    return null;\n  }\n  const uri = URI(window.location.search);\n  const endpoint = isNative ? 'annotation_json' : 'slice_json';\n  return uri.\n  pathname(`/superset/${endpoint}/${slice_id}`).\n  search({\n    form_data: safeStringify(form_data, (key, value) =>\n    value === null ? undefined : value),\n\n    force }).\n\n  toString();\n}\n\nexport function getURIDirectory(endpointType = 'base') {\n  // Building the directory part of the URI\n  if (\n  ['full', 'json', 'csv', 'query', 'results', 'samples'].includes(\n  endpointType))\n\n  {\n    return '/superset/explore_json/';\n  }\n  return '/superset/explore/';\n}\n\n/**\n * This gets the url of the explore page, with all the form data included explicitly.\n * This includes any form data overrides from the dashboard.\n */\nexport function getExploreLongUrl(\nformData,\nendpointType,\nallowOverflow = true,\nextraSearch = {})\n{\n  if (!formData.datasource) {\n    return null;\n  }\n\n  // remove formData params that we don't need in the explore url.\n  // These are present when generating explore urls from the dashboard page.\n  // This should be superseded by some sort of \"exploration context\" system\n  // where form data and other context is referenced by id.\n  const trimmedFormData = _omit(formData, ['dataMask', 'url_params']);\n\n  const uri = new URI('/');\n  const directory = getURIDirectory(endpointType);\n  const search = uri.search(true);\n  Object.keys(extraSearch).forEach((key) => {\n    search[key] = extraSearch[key];\n  });\n  search.form_data = safeStringify(trimmedFormData);\n  if (endpointType === URL_PARAMS.standalone.name) {\n    search.standalone = DashboardStandaloneMode.HIDE_NAV;\n  }\n  const url = uri.directory(directory).search(search).toString();\n  if (!allowOverflow && url.length > MAX_URL_LENGTH) {\n    const minimalFormData = {\n      datasource: formData.datasource,\n      viz_type: formData.viz_type };\n\n    return getExploreLongUrl(minimalFormData, endpointType, false, {\n      URL_IS_TOO_LONG_TO_SHARE: null });\n\n  }\n  return url;\n}\n\nexport function getExploreUrlFromDashboard(formData) {\n  // remove formData params that we don't need in the explore url.\n  // These are present when generating explore urls from the dashboard page.\n  // This should be superseded by some sort of \"exploration context\" system\n  // where form data and other context is referenced by id.\n  const trimmedFormData = _omit(formData, [\n  'dataMask',\n  'url_params',\n  'label_colors']);\n\n  return getExploreLongUrl(trimmedFormData, null, false);\n}\n\nexport function getChartDataUri({ path, qs, allowDomainSharding = false }) {\n  // The search params from the window.location are carried through,\n  // but can be specified with curUrl (used for unit tests to spoof\n  // the window.location).\n  let uri = new URI({\n    protocol: window.location.protocol.slice(0, -1),\n    hostname: getHostName(allowDomainSharding),\n    port: window.location.port ? window.location.port : '',\n    path });\n\n  if (qs) {\n    uri = uri.search(qs);\n  }\n  return uri;\n}\n\n/**\n * This gets the minimal url for the given form data.\n * If there are dashboard overrides present in the form data,\n * they will not be included in the url.\n */\nexport function getExploreUrl({\n  formData,\n  endpointType = 'base',\n  force = false,\n  curUrl = null,\n  requestParams = {},\n  allowDomainSharding = false,\n  method = 'POST' })\n{\n  if (!formData.datasource) {\n    return null;\n  }\n\n  // label_colors should not pollute the URL\n  // eslint-disable-next-line no-param-reassign\n  delete formData.label_colors;\n\n  let uri = getChartDataUri({ path: '/', allowDomainSharding });\n  if (curUrl) {\n    uri = URI(URI(curUrl).search());\n  }\n\n  const directory = getURIDirectory(endpointType);\n\n  // Building the querystring (search) part of the URI\n  const search = uri.search(true);\n  const { slice_id, extra_filters, adhoc_filters, viz_type } = formData;\n  if (slice_id) {\n    const form_data = { slice_id };\n    if (method === 'GET') {\n      form_data.viz_type = viz_type;\n      if (extra_filters && extra_filters.length) {\n        form_data.extra_filters = extra_filters;\n      }\n      if (adhoc_filters && adhoc_filters.length) {\n        form_data.adhoc_filters = adhoc_filters;\n      }\n    }\n    search.form_data = safeStringify(form_data);\n  }\n  if (force) {\n    search.force = 'true';\n  }\n  if (endpointType === 'csv') {\n    search.csv = 'true';\n  }\n  if (endpointType === URL_PARAMS.standalone.name) {\n    search.standalone = '1';\n  }\n  if (endpointType === 'query') {\n    search.query = 'true';\n  }\n  if (endpointType === 'results') {\n    search.results = 'true';\n  }\n  if (endpointType === 'samples') {\n    search.samples = 'true';\n  }\n  const paramNames = Object.keys(requestParams);\n  if (paramNames.length) {\n    paramNames.forEach((name) => {\n      if (requestParams.hasOwnProperty(name)) {\n        search[name] = requestParams[name];\n      }\n    });\n  }\n  return uri.search(search).directory(directory).toString();\n}\n\nexport const shouldUseLegacyApi = (formData) => {\n  const vizMetadata = getChartMetadataRegistry().get(formData.viz_type);\n  return vizMetadata ? vizMetadata.useLegacyApi : false;\n};\n\nexport const buildV1ChartDataPayload = ({\n  formData,\n  force,\n  resultFormat,\n  resultType,\n  setDataMask,\n  ownState }) =>\n{var _getChartBuildQueryRe;\n  const buildQuery = (_getChartBuildQueryRe =\n  getChartBuildQueryRegistry().get(formData.viz_type)) != null ? _getChartBuildQueryRe :\n  (buildQueryformData) =>\n  buildQueryContext(buildQueryformData, (baseQueryObject) => [\n  {\n    ...baseQueryObject }]);\n\n\n  return buildQuery(\n  {\n    ...formData,\n    force,\n    result_format: resultFormat,\n    result_type: resultType },\n\n  {\n    ownState,\n    hooks: {\n      setDataMask } });\n\n\n\n};\n\nexport const getLegacyEndpointType = ({ resultType, resultFormat }) =>\nresultFormat === 'csv' ? resultFormat : resultType;\n\nexport function postForm(url, payload, target = '_blank') {\n  if (!url) {\n    return;\n  }\n\n  const hiddenForm = document.createElement('form');\n  hiddenForm.action = url;\n  hiddenForm.method = 'POST';\n  hiddenForm.target = target;\n  const token = document.createElement('input');\n  token.type = 'hidden';\n  token.name = 'csrf_token';\n  token.value = (document.getElementById('csrf_token') || {}).value;\n  hiddenForm.appendChild(token);\n  const data = document.createElement('input');\n  data.type = 'hidden';\n  data.name = 'form_data';\n  data.value = safeStringify(payload);\n  hiddenForm.appendChild(data);\n\n  document.body.appendChild(hiddenForm);\n  hiddenForm.submit();\n  document.body.removeChild(hiddenForm);\n}\n\nexport const exportChart = ({\n  formData,\n  resultFormat = 'json',\n  resultType = 'full',\n  force = false,\n  ownState = {} }) =>\n{\n  let url;\n  let payload;\n  if (shouldUseLegacyApi(formData)) {\n    const endpointType = getLegacyEndpointType({ resultFormat, resultType });\n    url = getExploreUrl({\n      formData,\n      endpointType,\n      allowDomainSharding: false });\n\n    payload = formData;\n  } else {\n    url = '/api/v1/chart/data';\n    payload = buildV1ChartDataPayload({\n      formData,\n      force,\n      resultFormat,\n      resultType,\n      ownState });\n\n  }\n  postForm(url, payload);\n};\n\nexport const exploreChart = (formData) => {\n  const url = getExploreUrl({\n    formData,\n    endpointType: 'base',\n    allowDomainSharding: false });\n\n  postForm(url, formData);\n};\n\nexport const useDebouncedEffect = (effect, delay, deps) => {\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const callback = useCallback(effect, deps);\n\n  useEffect(() => {\n    const handler = setTimeout(() => {\n      callback();\n    }, delay);\n\n    return () => {\n      clearTimeout(handler);\n    };\n  }, [callback, delay]);\n};__signature__(useDebouncedEffect, \"useCallback{callback}\\nuseEffect{}\");__signature__(useDebouncedEffect, \"useCallback{callback}\\nuseEffect{}\");\n\nexport const getSimpleSQLExpression = (subject, operator, comparator) => {\n  const isMulti =\n  [...MULTI_OPERATORS].\n  map((op) => OPERATOR_ENUM_TO_OPERATOR_TYPE[op].operation).\n  indexOf(operator) >= 0;\n  let expression = subject != null ? subject : '';\n  if (subject && operator) {\n    expression += ` ${operator}`;\n    const firstValue =\n    isMulti && Array.isArray(comparator) ? comparator[0] : comparator;\n    const comparatorArray = ensureIsArray(comparator);\n    const isString =\n    firstValue !== undefined && Number.isNaN(Number(firstValue));\n    const quote = isString ? \"'\" : '';\n    const [prefix, suffix] = isMulti ? ['(', ')'] : ['', ''];\n    const formattedComparators = comparatorArray.map(\n    (val) =>\n    `${quote}${isString ? String(val).replace(\"'\", \"''\") : val}${quote}`);\n\n    if (comparatorArray.length > 0) {\n      expression += ` ${prefix}${formattedComparators.join(', ')}${suffix}`;\n    }\n  }\n  return expression;\n};;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(MAX_URL_LENGTH, \"MAX_URL_LENGTH\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getChartKey, \"getChartKey\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(requestCounter, \"requestCounter\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getHostName, \"getHostName\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getAnnotationJsonUrl, \"getAnnotationJsonUrl\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getURIDirectory, \"getURIDirectory\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getExploreLongUrl, \"getExploreLongUrl\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getExploreUrlFromDashboard, \"getExploreUrlFromDashboard\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getChartDataUri, \"getChartDataUri\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getExploreUrl, \"getExploreUrl\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(shouldUseLegacyApi, \"shouldUseLegacyApi\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(buildV1ChartDataPayload, \"buildV1ChartDataPayload\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getLegacyEndpointType, \"getLegacyEndpointType\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(postForm, \"postForm\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(exportChart, \"exportChart\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(exploreChart, \"exploreChart\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(useDebouncedEffect, \"useDebouncedEffect\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getSimpleSQLExpression, \"getSimpleSQLExpression\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(__signature__, \"__signature__\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(MAX_URL_LENGTH, \"MAX_URL_LENGTH\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getChartKey, \"getChartKey\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(requestCounter, \"requestCounter\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getHostName, \"getHostName\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getAnnotationJsonUrl, \"getAnnotationJsonUrl\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getURIDirectory, \"getURIDirectory\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getExploreLongUrl, \"getExploreLongUrl\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getExploreUrlFromDashboard, \"getExploreUrlFromDashboard\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getChartDataUri, \"getChartDataUri\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getExploreUrl, \"getExploreUrl\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(shouldUseLegacyApi, \"shouldUseLegacyApi\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(buildV1ChartDataPayload, \"buildV1ChartDataPayload\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getLegacyEndpointType, \"getLegacyEndpointType\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(postForm, \"postForm\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(exportChart, \"exportChart\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(exploreChart, \"exploreChart\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(useDebouncedEffect, \"useDebouncedEffect\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");reactHotLoader.register(getSimpleSQLExpression, \"getSimpleSQLExpression\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/ubuntu/my_plugin/superset/superset-frontend/src/explore/exploreUtils/index.js"],"names":["MAX_URL_LENGTH","getChartKey","slice","requestCounter","getHostName","allowDomainSharding","currentIndex","availableDomains","getAnnotationJsonUrl","slice_id","uri","URI","window","endpoint","isNative","form_data","safeStringify","value","getURIDirectory","endpointType","getExploreLongUrl","allowOverflow","extraSearch","formData","trimmedFormData","directory","search","Object","URL_PARAMS","DashboardStandaloneMode","url","minimalFormData","datasource","viz_type","URL_IS_TOO_LONG_TO_SHARE","getExploreUrlFromDashboard","getChartDataUri","protocol","hostname","port","getExploreUrl","force","curUrl","requestParams","method","path","extra_filters","adhoc_filters","paramNames","shouldUseLegacyApi","vizMetadata","getChartMetadataRegistry","buildV1ChartDataPayload","buildQuery","getChartBuildQueryRegistry","buildQueryContext","result_format","result_type","hooks","getLegacyEndpointType","resultFormat","postForm","target","hiddenForm","document","token","data","exportChart","resultType","ownState","payload","exploreChart","useDebouncedEffect","callback","useCallback","useEffect","handler","setTimeout","clearTimeout","getSimpleSQLExpression","isMulti","OPERATOR_ENUM_TO_OPERATOR_TYPE","expression","subject","operator","firstValue","Array","comparator","comparatorArray","ensureIsArray","isString","Number","quote","formattedComparators","String","val","prefix","suffix"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n\nimport { useCallback, useEffect } from 'react';\nimport { omit } from 'lodash';\n/* eslint camelcase: 0 */\nimport URI from 'urijs';\nimport {\n  buildQueryContext,\n  ensureIsArray,\n  getChartBuildQueryRegistry,\n  getChartMetadataRegistry,\n} from '@superset-ui/core';\nimport { availableDomains } from 'src/utils/hostNamesConfig';\nimport { safeStringify } from 'src/utils/safeStringify';\nimport { URL_PARAMS } from 'src/constants';\nimport {\n  MULTI_OPERATORS,\n  OPERATOR_ENUM_TO_OPERATOR_TYPE,\n} from 'src/explore/constants';\nimport { DashboardStandaloneMode } from 'src/dashboard/util/constants';\n\nconst MAX_URL_LENGTH = 8000;\n\nexport function getChartKey(explore) {\n  const { slice } = explore;\n  return slice ? slice.slice_id : 0;\n}\n\nlet requestCounter = 0;\nexport function getHostName(allowDomainSharding = false) {\n  let currentIndex = 0;\n  if (allowDomainSharding) {\n    currentIndex = requestCounter % availableDomains.length;\n    requestCounter += 1;\n\n    // if domain sharding is enabled, skip main domain for fetching chart API\n    // leave main domain free for other calls like fav star, save change, etc.\n    // to make dashboard be responsive when it's loading large number of charts\n    if (currentIndex === 0) {\n      currentIndex += 1;\n      requestCounter += 1;\n    }\n  }\n  return availableDomains[currentIndex];\n}\n\nexport function getAnnotationJsonUrl(slice_id, form_data, isNative, force) {\n  if (slice_id === null || slice_id === undefined) {\n    return null;\n  }\n  const uri = URI(window.location.search);\n  const endpoint = isNative ? 'annotation_json' : 'slice_json';\n  return uri\n    .pathname(`/superset/${endpoint}/${slice_id}`)\n    .search({\n      form_data: safeStringify(form_data, (key, value) =>\n        value === null ? undefined : value,\n      ),\n      force,\n    })\n    .toString();\n}\n\nexport function getURIDirectory(endpointType = 'base') {\n  // Building the directory part of the URI\n  if (\n    ['full', 'json', 'csv', 'query', 'results', 'samples'].includes(\n      endpointType,\n    )\n  ) {\n    return '/superset/explore_json/';\n  }\n  return '/superset/explore/';\n}\n\n/**\n * This gets the url of the explore page, with all the form data included explicitly.\n * This includes any form data overrides from the dashboard.\n */\nexport function getExploreLongUrl(\n  formData,\n  endpointType,\n  allowOverflow = true,\n  extraSearch = {},\n) {\n  if (!formData.datasource) {\n    return null;\n  }\n\n  // remove formData params that we don't need in the explore url.\n  // These are present when generating explore urls from the dashboard page.\n  // This should be superseded by some sort of \"exploration context\" system\n  // where form data and other context is referenced by id.\n  const trimmedFormData = omit(formData, ['dataMask', 'url_params']);\n\n  const uri = new URI('/');\n  const directory = getURIDirectory(endpointType);\n  const search = uri.search(true);\n  Object.keys(extraSearch).forEach(key => {\n    search[key] = extraSearch[key];\n  });\n  search.form_data = safeStringify(trimmedFormData);\n  if (endpointType === URL_PARAMS.standalone.name) {\n    search.standalone = DashboardStandaloneMode.HIDE_NAV;\n  }\n  const url = uri.directory(directory).search(search).toString();\n  if (!allowOverflow && url.length > MAX_URL_LENGTH) {\n    const minimalFormData = {\n      datasource: formData.datasource,\n      viz_type: formData.viz_type,\n    };\n    return getExploreLongUrl(minimalFormData, endpointType, false, {\n      URL_IS_TOO_LONG_TO_SHARE: null,\n    });\n  }\n  return url;\n}\n\nexport function getExploreUrlFromDashboard(formData) {\n  // remove formData params that we don't need in the explore url.\n  // These are present when generating explore urls from the dashboard page.\n  // This should be superseded by some sort of \"exploration context\" system\n  // where form data and other context is referenced by id.\n  const trimmedFormData = omit(formData, [\n    'dataMask',\n    'url_params',\n    'label_colors',\n  ]);\n  return getExploreLongUrl(trimmedFormData, null, false);\n}\n\nexport function getChartDataUri({ path, qs, allowDomainSharding = false }) {\n  // The search params from the window.location are carried through,\n  // but can be specified with curUrl (used for unit tests to spoof\n  // the window.location).\n  let uri = new URI({\n    protocol: window.location.protocol.slice(0, -1),\n    hostname: getHostName(allowDomainSharding),\n    port: window.location.port ? window.location.port : '',\n    path,\n  });\n  if (qs) {\n    uri = uri.search(qs);\n  }\n  return uri;\n}\n\n/**\n * This gets the minimal url for the given form data.\n * If there are dashboard overrides present in the form data,\n * they will not be included in the url.\n */\nexport function getExploreUrl({\n  formData,\n  endpointType = 'base',\n  force = false,\n  curUrl = null,\n  requestParams = {},\n  allowDomainSharding = false,\n  method = 'POST',\n}) {\n  if (!formData.datasource) {\n    return null;\n  }\n\n  // label_colors should not pollute the URL\n  // eslint-disable-next-line no-param-reassign\n  delete formData.label_colors;\n\n  let uri = getChartDataUri({ path: '/', allowDomainSharding });\n  if (curUrl) {\n    uri = URI(URI(curUrl).search());\n  }\n\n  const directory = getURIDirectory(endpointType);\n\n  // Building the querystring (search) part of the URI\n  const search = uri.search(true);\n  const { slice_id, extra_filters, adhoc_filters, viz_type } = formData;\n  if (slice_id) {\n    const form_data = { slice_id };\n    if (method === 'GET') {\n      form_data.viz_type = viz_type;\n      if (extra_filters && extra_filters.length) {\n        form_data.extra_filters = extra_filters;\n      }\n      if (adhoc_filters && adhoc_filters.length) {\n        form_data.adhoc_filters = adhoc_filters;\n      }\n    }\n    search.form_data = safeStringify(form_data);\n  }\n  if (force) {\n    search.force = 'true';\n  }\n  if (endpointType === 'csv') {\n    search.csv = 'true';\n  }\n  if (endpointType === URL_PARAMS.standalone.name) {\n    search.standalone = '1';\n  }\n  if (endpointType === 'query') {\n    search.query = 'true';\n  }\n  if (endpointType === 'results') {\n    search.results = 'true';\n  }\n  if (endpointType === 'samples') {\n    search.samples = 'true';\n  }\n  const paramNames = Object.keys(requestParams);\n  if (paramNames.length) {\n    paramNames.forEach(name => {\n      if (requestParams.hasOwnProperty(name)) {\n        search[name] = requestParams[name];\n      }\n    });\n  }\n  return uri.search(search).directory(directory).toString();\n}\n\nexport const shouldUseLegacyApi = formData => {\n  const vizMetadata = getChartMetadataRegistry().get(formData.viz_type);\n  return vizMetadata ? vizMetadata.useLegacyApi : false;\n};\n\nexport const buildV1ChartDataPayload = ({\n  formData,\n  force,\n  resultFormat,\n  resultType,\n  setDataMask,\n  ownState,\n}) => {\n  const buildQuery =\n    getChartBuildQueryRegistry().get(formData.viz_type) ??\n    (buildQueryformData =>\n      buildQueryContext(buildQueryformData, baseQueryObject => [\n        {\n          ...baseQueryObject,\n        },\n      ]));\n  return buildQuery(\n    {\n      ...formData,\n      force,\n      result_format: resultFormat,\n      result_type: resultType,\n    },\n    {\n      ownState,\n      hooks: {\n        setDataMask,\n      },\n    },\n  );\n};\n\nexport const getLegacyEndpointType = ({ resultType, resultFormat }) =>\n  resultFormat === 'csv' ? resultFormat : resultType;\n\nexport function postForm(url, payload, target = '_blank') {\n  if (!url) {\n    return;\n  }\n\n  const hiddenForm = document.createElement('form');\n  hiddenForm.action = url;\n  hiddenForm.method = 'POST';\n  hiddenForm.target = target;\n  const token = document.createElement('input');\n  token.type = 'hidden';\n  token.name = 'csrf_token';\n  token.value = (document.getElementById('csrf_token') || {}).value;\n  hiddenForm.appendChild(token);\n  const data = document.createElement('input');\n  data.type = 'hidden';\n  data.name = 'form_data';\n  data.value = safeStringify(payload);\n  hiddenForm.appendChild(data);\n\n  document.body.appendChild(hiddenForm);\n  hiddenForm.submit();\n  document.body.removeChild(hiddenForm);\n}\n\nexport const exportChart = ({\n  formData,\n  resultFormat = 'json',\n  resultType = 'full',\n  force = false,\n  ownState = {},\n}) => {\n  let url;\n  let payload;\n  if (shouldUseLegacyApi(formData)) {\n    const endpointType = getLegacyEndpointType({ resultFormat, resultType });\n    url = getExploreUrl({\n      formData,\n      endpointType,\n      allowDomainSharding: false,\n    });\n    payload = formData;\n  } else {\n    url = '/api/v1/chart/data';\n    payload = buildV1ChartDataPayload({\n      formData,\n      force,\n      resultFormat,\n      resultType,\n      ownState,\n    });\n  }\n  postForm(url, payload);\n};\n\nexport const exploreChart = formData => {\n  const url = getExploreUrl({\n    formData,\n    endpointType: 'base',\n    allowDomainSharding: false,\n  });\n  postForm(url, formData);\n};\n\nexport const useDebouncedEffect = (effect, delay, deps) => {\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const callback = useCallback(effect, deps);\n\n  useEffect(() => {\n    const handler = setTimeout(() => {\n      callback();\n    }, delay);\n\n    return () => {\n      clearTimeout(handler);\n    };\n  }, [callback, delay]);\n};\n\nexport const getSimpleSQLExpression = (subject, operator, comparator) => {\n  const isMulti =\n    [...MULTI_OPERATORS]\n      .map(op => OPERATOR_ENUM_TO_OPERATOR_TYPE[op].operation)\n      .indexOf(operator) >= 0;\n  let expression = subject ?? '';\n  if (subject && operator) {\n    expression += ` ${operator}`;\n    const firstValue =\n      isMulti && Array.isArray(comparator) ? comparator[0] : comparator;\n    const comparatorArray = ensureIsArray(comparator);\n    const isString =\n      firstValue !== undefined && Number.isNaN(Number(firstValue));\n    const quote = isString ? \"'\" : '';\n    const [prefix, suffix] = isMulti ? ['(', ')'] : ['', ''];\n    const formattedComparators = comparatorArray.map(\n      val =>\n        `${quote}${isString ? String(val).replace(\"'\", \"''\") : val}${quote}`,\n    );\n    if (comparatorArray.length > 0) {\n      expression += ` ${prefix}${formattedComparators.join(', ')}${suffix}`;\n    }\n  }\n  return expression;\n};\n"]},"metadata":{},"sourceType":"module"}