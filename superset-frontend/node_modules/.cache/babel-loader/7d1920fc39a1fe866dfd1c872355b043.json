{"ast":null,"code":"import _debounce from \"lodash/debounce\";import _sortBy from \"lodash/sortBy\";import _isEqual from \"lodash/isEqual\";import _uniq from \"lodash/uniq\";var _jsxFileName = \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, { useEffect, useCallback, useMemo, useState, useRef } from 'react';\n\nimport { t, styled, SLOW_DEBOUNCE } from '@superset-ui/core';\nimport { Form } from 'src/common/components';\nimport { StyledModal } from 'src/components/Modal';\nimport ErrorBoundary from 'src/components/ErrorBoundary';\nimport { testWithId } from 'src/utils/testUtils';\nimport { useFilterConfigMap, useFilterConfiguration } from '../state';\nimport { validateForm, createHandleSave, createHandleTabEdit, generateFilterId, getFilterIds } from './utils';\nimport Footer from './Footer/Footer';\nimport FilterTabs from './FilterTabs';\nimport FiltersConfigForm from './FiltersConfigForm/FiltersConfigForm';\nimport { useOpenModal, useRemoveCurrentFilter } from './state';import { jsx as ___EmotionJSX } from \"@emotion/react\";\nconst StyledModalWrapper = styled(StyledModal)`\n  min-width: 700px;\n  .ant-modal-body {\n    padding: 0px;\n  }\n`;\nexport const StyledModalBody = styled.div`\n  display: flex;\n  height: 700px;\n  flex-direction: row;\n  .filters-list {\n    width: ${({ theme }) => theme.gridUnit * 50}px;\n    overflow: auto;\n  }\n`;\nexport const StyledForm = styled(Form)`\n  width: 100%;\n`;\nexport const FILTERS_CONFIG_MODAL_TEST_ID = 'filters-config-modal';\nexport const getFiltersConfigModalTestId = testWithId(FILTERS_CONFIG_MODAL_TEST_ID);\nexport const CASCADING_FILTERS = ['filter_select'];\n/**\n * This is the modal to configure all the dashboard-native filters.\n * Manages modal-level state, such as what filters are in the list,\n * and which filter is currently being edited.\n *\n * Calls the `save` callback with the new FilterConfiguration object\n * when the user saves the filters.\n */\nexport function FiltersConfigModal({ isOpen, initialFilterId, createNewOnOpen, onSave, onCancel }) {\n  const [form] = Form.useForm();\n  const configFormRef = useRef();\n  // the filter config from redux state, this does not change until modal is closed.\n  const filterConfig = useFilterConfiguration();\n  const filterConfigMap = useFilterConfigMap();\n  // new filter ids belong to filters have been added during\n  // this configuration session, and only exist in the form state until we submit.\n  const [newFilterIds, setNewFilterIds] = useState([]);\n  // store ids of filters that have been removed with the time they were removed\n  // so that we can disappear them after a few secs.\n  // filters are still kept in state until form is submitted.\n  const [removedFilters, setRemovedFilters] = useState({});\n  const [saveAlertVisible, setSaveAlertVisible] = useState(false);\n  // The full ordered set of ((original + new) - completely removed) filter ids\n  // Use this as the canonical list of what filters are being configured!\n  // This includes filter ids that are pending removal, so check for that.\n  const filterIds = useMemo(() => _uniq([...getFilterIds(filterConfig), ...newFilterIds]).filter((id) => {var _removedFilters$id;return !removedFilters[id] || ((_removedFilters$id = removedFilters[id]) == null ? void 0 : _removedFilters$id.isPending);}), [filterConfig, newFilterIds, removedFilters]);\n  // open the first filter in the list to start\n  const initialCurrentFilterId = initialFilterId != null ? initialFilterId : filterIds[0];\n  const [currentFilterId, setCurrentFilterId] = useState(initialCurrentFilterId);\n  const [erroredFilters, setErroredFilters] = useState([]);\n  // the form values are managed by the antd form, but we copy them to here\n  // so that we can display them (e.g. filter titles in the tab headers)\n  const [formValues, setFormValues] = useState({\n    filters: {} });\n\n  const unsavedFiltersIds = newFilterIds.filter((id) => !removedFilters[id]);\n  // brings back a filter that was previously removed (\"Undo\")\n  const restoreFilter = (id) => {\n    const removal = removedFilters[id];\n    // gotta clear the removal timeout to prevent the filter from getting deleted\n    if (removal != null && removal.isPending)\n    clearTimeout(removal.timerId);\n    setRemovedFilters((current) => ({ ...current, [id]: null }));\n  };\n  // generates a new filter id and appends it to the newFilterIds\n  const addFilter = useCallback(() => {\n    const newFilterId = generateFilterId();\n    setNewFilterIds([...newFilterIds, newFilterId]);\n    setCurrentFilterId(newFilterId);\n    setSaveAlertVisible(false);\n  }, [newFilterIds, setCurrentFilterId]);\n  useOpenModal(isOpen, addFilter, createNewOnOpen);\n  useRemoveCurrentFilter(removedFilters, currentFilterId, filterIds, setCurrentFilterId);\n  const handleTabEdit = createHandleTabEdit(setRemovedFilters, setSaveAlertVisible, addFilter);\n  // After this, it should be as if the modal was just opened fresh.\n  // Called when the modal is closed.\n  const resetForm = () => {\n    setNewFilterIds([]);\n    setCurrentFilterId(initialCurrentFilterId);\n    setRemovedFilters({});\n    setSaveAlertVisible(false);\n    setFormValues({ filters: {} });\n    form.setFieldsValue({ changed: false });\n    setErroredFilters([]);\n  };\n  const getFilterTitle = (id) => {var _formValues$filters$i, _filterConfigMap$id;return ((_formValues$filters$i = formValues.filters[id]) == null ? void 0 : _formValues$filters$i.name) || ((_filterConfigMap$id =\n    filterConfigMap[id]) == null ? void 0 : _filterConfigMap$id.name) ||\n    t('[untitled]');};\n  const getParentFilters = (id) => filterIds.\n  filter((filterId) => filterId !== id && !removedFilters[filterId]).\n  filter((filterId) => {var _filterConfigMap$filt;return CASCADING_FILTERS.includes(formValues.filters[filterId] ?\n    formValues.filters[filterId].filterType : (_filterConfigMap$filt =\n    filterConfigMap[filterId]) == null ? void 0 : _filterConfigMap$filt.filterType);}).\n  map((id) => ({\n    id,\n    title: getFilterTitle(id) }));\n\n  const cleanDeletedParents = (values) => {\n    Object.keys(filterConfigMap).forEach((key) => {var _filter$cascadeParent;\n      const filter = filterConfigMap[key];\n      const parentId = (_filter$cascadeParent = filter.cascadeParentIds) == null ? void 0 : _filter$cascadeParent[0];\n      if (parentId && removedFilters[parentId]) {\n        filter.cascadeParentIds = [];\n      }\n    });\n    const filters = values == null ? void 0 : values.filters;\n    if (filters) {\n      Object.keys(filters).forEach((key) => {var _filter$parentFilter;\n        const filter = filters[key];\n        const parentId = (_filter$parentFilter = filter.parentFilter) == null ? void 0 : _filter$parentFilter.value;\n        if (parentId && removedFilters[parentId]) {\n          filter.parentFilter = undefined;\n        }\n      });\n    }\n  };\n  const handleErroredFilters = useCallback(() => {\n    // managing left pane errored filters indicators\n    const formValidationFields = form.getFieldsError();\n    const erroredFiltersIds = [];\n    formValidationFields.forEach((field) => {\n      const filterId = field.name[1];\n      if (field.errors.length > 0 && !erroredFiltersIds.includes(filterId)) {\n        erroredFiltersIds.push(filterId);\n      }\n    });\n    // no form validation issues found, resets errored filters\n    if (!erroredFiltersIds.length && erroredFilters.length > 0) {\n      setErroredFilters([]);\n      return;\n    }\n    // form validation issues found, sets errored filters\n    if (erroredFiltersIds.length > 0 &&\n    !_isEqual(_sortBy(erroredFilters), _sortBy(erroredFiltersIds))) {\n      setErroredFilters(erroredFiltersIds);\n    }\n  }, [form, erroredFilters]);\n  const handleSave = async () => {\n    const values = await validateForm(form, currentFilterId, filterConfigMap, filterIds, removedFilters, setCurrentFilterId);\n    handleErroredFilters();\n    if (values) {\n      cleanDeletedParents(values);\n      createHandleSave(filterConfigMap, filterIds, removedFilters, onSave, values)();\n      resetForm();\n    } else\n    {\n      configFormRef.current.changeTab('configuration');\n    }\n  };\n  const handleConfirmCancel = () => {\n    resetForm();\n    onCancel();\n  };\n  const handleCancel = () => {\n    const changed = form.getFieldValue('changed');\n    if (unsavedFiltersIds.length > 0 || form.isFieldsTouched() || changed) {\n      setSaveAlertVisible(true);\n    } else\n    {\n      handleConfirmCancel();\n    }\n  };\n  const onValuesChange = useMemo(() => _debounce((changes, values) => {\n    if (changes.filters) {\n      if (Object.values(changes.filters).some((filter) => filter.name != null)) {\n        // we only need to set this if a name changed\n        setFormValues(values);\n      }\n      handleErroredFilters();\n    }\n    setSaveAlertVisible(false);\n  }, SLOW_DEBOUNCE), [handleErroredFilters]);\n  useEffect(() => {\n    setErroredFilters((prevErroredFilters) => prevErroredFilters.filter((f) => !removedFilters[f]));\n  }, [removedFilters]);\n  return ___EmotionJSX(StyledModalWrapper, { visible: isOpen, maskClosable: false, title: t('Filters configuration and scoping'), width: \"50%\", destroyOnClose: true, onCancel: handleCancel, onOk: handleSave, centered: true, \"data-test\": \"filter-modal\", footer: ___EmotionJSX(Footer, { onDismiss: () => setSaveAlertVisible(false), onCancel: handleCancel, handleSave: handleSave, canSave: !erroredFilters.length, saveAlertVisible: saveAlertVisible, onConfirmCancel: handleConfirmCancel, __self: this, __source: { fileName: _jsxFileName, lineNumber: 208, columnNumber: 229 } }), __self: this, __source: { fileName: _jsxFileName, lineNumber: 208, columnNumber: 13 } },\n  ___EmotionJSX(ErrorBoundary, { __self: this, __source: { fileName: _jsxFileName, lineNumber: 209, columnNumber: 7 } },\n  ___EmotionJSX(StyledModalBody, { __self: this, __source: { fileName: _jsxFileName, lineNumber: 210, columnNumber: 9 } },\n  ___EmotionJSX(StyledForm, { preserve: false, form: form, onValuesChange: onValuesChange, layout: \"vertical\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 211, columnNumber: 11 } },\n  ___EmotionJSX(FilterTabs, { erroredFilters: erroredFilters, onEdit: handleTabEdit, onChange: setCurrentFilterId, getFilterTitle: getFilterTitle, currentFilterId: currentFilterId, filterIds: filterIds, removedFilters: removedFilters, restoreFilter: restoreFilter, __self: this, __source: { fileName: _jsxFileName, lineNumber: 212, columnNumber: 13 } },\n  (id) => ___EmotionJSX(FiltersConfigForm, { ref: configFormRef, form: form, filterId: id, filterToEdit: filterConfigMap[id], removedFilters: removedFilters, restoreFilter: restoreFilter, parentFilters: getParentFilters(id), setErroredFilters: setErroredFilters, __self: this, __source: { fileName: _jsxFileName, lineNumber: 213, columnNumber: 25 } }))))));\n\n\n\n\n\n}__signature__(FiltersConfigModal, \"useForm{[form]}\\nuseRef{configFormRef}\\nuseFilterConfiguration{filterConfig}\\nuseFilterConfigMap{filterConfigMap}\\nuseState{[newFilterIds, setNewFilterIds]([])}\\nuseState{[removedFilters, setRemovedFilters]({})}\\nuseState{[saveAlertVisible, setSaveAlertVisible](false)}\\nuseMemo{filterIds}\\nuseState{[currentFilterId, setCurrentFilterId](initialCurrentFilterId)}\\nuseState{[erroredFilters, setErroredFilters]([])}\\nuseState{[formValues, setFormValues]({\\n        filters: {},\\n    })}\\nuseCallback{addFilter}\\nuseOpenModal{}\\nuseRemoveCurrentFilter{}\\nuseCallback{handleErroredFilters}\\nuseMemo{onValuesChange}\\nuseEffect{}\", () => [useFilterConfiguration, useFilterConfigMap, useOpenModal, useRemoveCurrentFilter]);;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(StyledModalWrapper, \"StyledModalWrapper\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(StyledModalBody, \"StyledModalBody\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(StyledForm, \"StyledForm\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(FILTERS_CONFIG_MODAL_TEST_ID, \"FILTERS_CONFIG_MODAL_TEST_ID\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(getFiltersConfigModalTestId, \"getFiltersConfigModalTestId\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(CASCADING_FILTERS, \"CASCADING_FILTERS\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(FiltersConfigModal, \"FiltersConfigModal\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx"],"names":[],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, {\n  useEffect,\n  useCallback,\n  useMemo,\n  useState,\n  useRef,\n} from 'react';\nimport { uniq, isEqual, sortBy, debounce } from 'lodash';\nimport { t, styled, SLOW_DEBOUNCE } from '@superset-ui/core';\nimport { Form } from 'src/common/components';\nimport { StyledModal } from 'src/components/Modal';\nimport ErrorBoundary from 'src/components/ErrorBoundary';\nimport { testWithId } from 'src/utils/testUtils';\nimport { useFilterConfigMap, useFilterConfiguration } from '../state';\nimport { FilterRemoval, NativeFiltersForm } from './types';\nimport { FilterConfiguration } from '../types';\nimport {\n  validateForm,\n  createHandleSave,\n  createHandleTabEdit,\n  generateFilterId,\n  getFilterIds,\n} from './utils';\nimport Footer from './Footer/Footer';\nimport FilterTabs from './FilterTabs';\nimport FiltersConfigForm from './FiltersConfigForm/FiltersConfigForm';\nimport { useOpenModal, useRemoveCurrentFilter } from './state';\n\nconst StyledModalWrapper = styled(StyledModal)`\n  min-width: 700px;\n  .ant-modal-body {\n    padding: 0px;\n  }\n`;\n\nexport const StyledModalBody = styled.div`\n  display: flex;\n  height: 700px;\n  flex-direction: row;\n  .filters-list {\n    width: ${({ theme }) => theme.gridUnit * 50}px;\n    overflow: auto;\n  }\n`;\n\nexport const StyledForm = styled(Form)`\n  width: 100%;\n`;\n\nexport const FILTERS_CONFIG_MODAL_TEST_ID = 'filters-config-modal';\nexport const getFiltersConfigModalTestId = testWithId(\n  FILTERS_CONFIG_MODAL_TEST_ID,\n);\n\nexport interface FiltersConfigModalProps {\n  isOpen: boolean;\n  initialFilterId?: string;\n  createNewOnOpen?: boolean;\n  onSave: (filterConfig: FilterConfiguration) => Promise<void>;\n  onCancel: () => void;\n}\nexport const CASCADING_FILTERS = ['filter_select'];\n\n/**\n * This is the modal to configure all the dashboard-native filters.\n * Manages modal-level state, such as what filters are in the list,\n * and which filter is currently being edited.\n *\n * Calls the `save` callback with the new FilterConfiguration object\n * when the user saves the filters.\n */\nexport function FiltersConfigModal({\n  isOpen,\n  initialFilterId,\n  createNewOnOpen,\n  onSave,\n  onCancel,\n}: FiltersConfigModalProps) {\n  const [form] = Form.useForm<NativeFiltersForm>();\n\n  const configFormRef = useRef<any>();\n\n  // the filter config from redux state, this does not change until modal is closed.\n  const filterConfig = useFilterConfiguration();\n  const filterConfigMap = useFilterConfigMap();\n\n  // new filter ids belong to filters have been added during\n  // this configuration session, and only exist in the form state until we submit.\n  const [newFilterIds, setNewFilterIds] = useState<string[]>([]);\n\n  // store ids of filters that have been removed with the time they were removed\n  // so that we can disappear them after a few secs.\n  // filters are still kept in state until form is submitted.\n  const [removedFilters, setRemovedFilters] = useState<\n    Record<string, FilterRemoval>\n  >({});\n\n  const [saveAlertVisible, setSaveAlertVisible] = useState<boolean>(false);\n\n  // The full ordered set of ((original + new) - completely removed) filter ids\n  // Use this as the canonical list of what filters are being configured!\n  // This includes filter ids that are pending removal, so check for that.\n  const filterIds = useMemo(\n    () =>\n      uniq([...getFilterIds(filterConfig), ...newFilterIds]).filter(\n        id => !removedFilters[id] || removedFilters[id]?.isPending,\n      ),\n    [filterConfig, newFilterIds, removedFilters],\n  );\n\n  // open the first filter in the list to start\n  const initialCurrentFilterId = initialFilterId ?? filterIds[0];\n  const [currentFilterId, setCurrentFilterId] = useState(\n    initialCurrentFilterId,\n  );\n  const [erroredFilters, setErroredFilters] = useState<string[]>([]);\n\n  // the form values are managed by the antd form, but we copy them to here\n  // so that we can display them (e.g. filter titles in the tab headers)\n  const [formValues, setFormValues] = useState<NativeFiltersForm>({\n    filters: {},\n  });\n\n  const unsavedFiltersIds = newFilterIds.filter(id => !removedFilters[id]);\n  // brings back a filter that was previously removed (\"Undo\")\n  const restoreFilter = (id: string) => {\n    const removal = removedFilters[id];\n    // gotta clear the removal timeout to prevent the filter from getting deleted\n    if (removal?.isPending) clearTimeout(removal.timerId);\n    setRemovedFilters(current => ({ ...current, [id]: null }));\n  };\n\n  // generates a new filter id and appends it to the newFilterIds\n  const addFilter = useCallback(() => {\n    const newFilterId = generateFilterId();\n    setNewFilterIds([...newFilterIds, newFilterId]);\n    setCurrentFilterId(newFilterId);\n    setSaveAlertVisible(false);\n  }, [newFilterIds, setCurrentFilterId]);\n\n  useOpenModal(isOpen, addFilter, createNewOnOpen);\n\n  useRemoveCurrentFilter(\n    removedFilters,\n    currentFilterId,\n    filterIds,\n    setCurrentFilterId,\n  );\n\n  const handleTabEdit = createHandleTabEdit(\n    setRemovedFilters,\n    setSaveAlertVisible,\n    addFilter,\n  );\n\n  // After this, it should be as if the modal was just opened fresh.\n  // Called when the modal is closed.\n  const resetForm = () => {\n    setNewFilterIds([]);\n    setCurrentFilterId(initialCurrentFilterId);\n    setRemovedFilters({});\n    setSaveAlertVisible(false);\n    setFormValues({ filters: {} });\n    form.setFieldsValue({ changed: false });\n    setErroredFilters([]);\n  };\n\n  const getFilterTitle = (id: string) =>\n    formValues.filters[id]?.name ||\n    filterConfigMap[id]?.name ||\n    t('[untitled]');\n\n  const getParentFilters = (id: string) =>\n    filterIds\n      .filter(filterId => filterId !== id && !removedFilters[filterId])\n      .filter(filterId =>\n        CASCADING_FILTERS.includes(\n          formValues.filters[filterId]\n            ? formValues.filters[filterId].filterType\n            : filterConfigMap[filterId]?.filterType,\n        ),\n      )\n      .map(id => ({\n        id,\n        title: getFilterTitle(id),\n      }));\n\n  const cleanDeletedParents = (values: NativeFiltersForm | null) => {\n    Object.keys(filterConfigMap).forEach(key => {\n      const filter = filterConfigMap[key];\n      const parentId = filter.cascadeParentIds?.[0];\n      if (parentId && removedFilters[parentId]) {\n        filter.cascadeParentIds = [];\n      }\n    });\n\n    const filters = values?.filters;\n    if (filters) {\n      Object.keys(filters).forEach(key => {\n        const filter = filters[key];\n        const parentId = filter.parentFilter?.value;\n        if (parentId && removedFilters[parentId]) {\n          filter.parentFilter = undefined;\n        }\n      });\n    }\n  };\n\n  const handleErroredFilters = useCallback(() => {\n    // managing left pane errored filters indicators\n    const formValidationFields = form.getFieldsError();\n    const erroredFiltersIds: string[] = [];\n\n    formValidationFields.forEach(field => {\n      const filterId = field.name[1] as string;\n      if (field.errors.length > 0 && !erroredFiltersIds.includes(filterId)) {\n        erroredFiltersIds.push(filterId);\n      }\n    });\n\n    // no form validation issues found, resets errored filters\n    if (!erroredFiltersIds.length && erroredFilters.length > 0) {\n      setErroredFilters([]);\n      return;\n    }\n    // form validation issues found, sets errored filters\n    if (\n      erroredFiltersIds.length > 0 &&\n      !isEqual(sortBy(erroredFilters), sortBy(erroredFiltersIds))\n    ) {\n      setErroredFilters(erroredFiltersIds);\n    }\n  }, [form, erroredFilters]);\n\n  const handleSave = async () => {\n    const values: NativeFiltersForm | null = await validateForm(\n      form,\n      currentFilterId,\n      filterConfigMap,\n      filterIds,\n      removedFilters,\n      setCurrentFilterId,\n    );\n\n    handleErroredFilters();\n\n    if (values) {\n      cleanDeletedParents(values);\n      createHandleSave(\n        filterConfigMap,\n        filterIds,\n        removedFilters,\n        onSave,\n        values,\n      )();\n      resetForm();\n    } else {\n      configFormRef.current.changeTab('configuration');\n    }\n  };\n\n  const handleConfirmCancel = () => {\n    resetForm();\n    onCancel();\n  };\n\n  const handleCancel = () => {\n    const changed = form.getFieldValue('changed');\n    if (unsavedFiltersIds.length > 0 || form.isFieldsTouched() || changed) {\n      setSaveAlertVisible(true);\n    } else {\n      handleConfirmCancel();\n    }\n  };\n\n  const onValuesChange = useMemo(\n    () =>\n      debounce((changes: any, values: NativeFiltersForm) => {\n        if (changes.filters) {\n          if (\n            Object.values(changes.filters).some(\n              (filter: any) => filter.name != null,\n            )\n          ) {\n            // we only need to set this if a name changed\n            setFormValues(values);\n          }\n          handleErroredFilters();\n        }\n        setSaveAlertVisible(false);\n      }, SLOW_DEBOUNCE),\n    [handleErroredFilters],\n  );\n\n  useEffect(() => {\n    setErroredFilters(prevErroredFilters =>\n      prevErroredFilters.filter(f => !removedFilters[f]),\n    );\n  }, [removedFilters]);\n\n  return (\n    <StyledModalWrapper\n      visible={isOpen}\n      maskClosable={false}\n      title={t('Filters configuration and scoping')}\n      width=\"50%\"\n      destroyOnClose\n      onCancel={handleCancel}\n      onOk={handleSave}\n      centered\n      data-test=\"filter-modal\"\n      footer={\n        <Footer\n          onDismiss={() => setSaveAlertVisible(false)}\n          onCancel={handleCancel}\n          handleSave={handleSave}\n          canSave={!erroredFilters.length}\n          saveAlertVisible={saveAlertVisible}\n          onConfirmCancel={handleConfirmCancel}\n        />\n      }\n    >\n      <ErrorBoundary>\n        <StyledModalBody>\n          <StyledForm\n            preserve={false}\n            form={form}\n            onValuesChange={onValuesChange}\n            layout=\"vertical\"\n          >\n            <FilterTabs\n              erroredFilters={erroredFilters}\n              onEdit={handleTabEdit}\n              onChange={setCurrentFilterId}\n              getFilterTitle={getFilterTitle}\n              currentFilterId={currentFilterId}\n              filterIds={filterIds}\n              removedFilters={removedFilters}\n              restoreFilter={restoreFilter}\n            >\n              {(id: string) => (\n                <FiltersConfigForm\n                  ref={configFormRef}\n                  form={form}\n                  filterId={id}\n                  filterToEdit={filterConfigMap[id]}\n                  removedFilters={removedFilters}\n                  restoreFilter={restoreFilter}\n                  parentFilters={getParentFilters(id)}\n                  setErroredFilters={setErroredFilters}\n                />\n              )}\n            </FilterTabs>\n          </StyledForm>\n        </StyledModalBody>\n      </ErrorBoundary>\n    </StyledModalWrapper>\n  );\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}