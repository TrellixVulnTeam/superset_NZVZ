{"ast":null,"code":"import _isEqualWith from \"lodash/isEqualWith\";import _isEqual from \"lodash/isEqual\";var _jsxFileName = \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterControls/FilterValue.tsx\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, { useEffect, useRef, useState } from 'react';\nimport { SuperChart, t, styled, Behavior, getChartMetadataRegistry } from '@superset-ui/core';\nimport { useDispatch, useSelector } from 'react-redux';\n\nimport { getChartDataRequest } from 'src/chart/chartAction';\nimport Loading from 'src/components/Loading';\nimport BasicErrorAlert from 'src/components/ErrorMessage/BasicErrorAlert';\nimport { FeatureFlag, isFeatureEnabled } from 'src/featureFlags';\nimport { waitForAsyncData } from 'src/middleware/asyncEvent';\nimport { dispatchFocusAction } from './utils';\nimport { getFormData } from '../../utils';\nimport { useCascadingFilters } from './state';\nimport { checkIsMissingRequiredValue } from '../utils';import { jsx as ___EmotionJSX } from \"@emotion/react\";\nconst HEIGHT = 32;\n// Overrides superset-ui height with min-height\nconst StyledDiv = styled.div`\n  & > div {\n    height: auto !important;\n    min-height: ${HEIGHT}px;\n  }\n`;\nconst FilterValue = ({ dataMaskSelected, filter, directPathToChild, onFilterSelectionChange, inView = true }) => {var _filter$dataMask2, _filter$dataMask3, _filter$dataMask4;\n  const { id, targets, filterType, adhoc_filters, time_range } = filter;\n  const metadata = getChartMetadataRegistry().get(filterType);\n  const cascadingFilters = useCascadingFilters(id, dataMaskSelected);\n  const isDashboardRefreshing = useSelector((state) => state.dashboardState.isRefreshing);\n  const [state, setState] = useState([]);\n  const [error, setError] = useState('');\n  const [formData, setFormData] = useState({\n    inView: false });\n\n  const [ownState, setOwnState] = useState({});\n  const [inViewFirstTime, setInViewFirstTime] = useState(inView);\n  const inputRef = useRef(null);\n  const [target] = targets;\n  const { datasetId, column = {} } = target;\n  const { name: groupby } = column;\n  const hasDataSource = !!datasetId;\n  const [isLoading, setIsLoading] = useState(hasDataSource);\n  const [isRefreshing, setIsRefreshing] = useState(false);\n  const dispatch = useDispatch();\n  useEffect(() => {\n    if (!inViewFirstTime && inView) {\n      setInViewFirstTime(true);\n    }\n  }, [inView, inViewFirstTime, setInViewFirstTime]);\n  useEffect(() => {var _filter$dataMask;\n    if (!inViewFirstTime) {\n      return;\n    }\n    const newFormData = getFormData({\n      ...filter,\n      datasetId,\n      cascadingFilters,\n      groupby,\n      inputRef,\n      adhoc_filters,\n      time_range });\n\n    const filterOwnState = ((_filter$dataMask = filter.dataMask) == null ? void 0 : _filter$dataMask.ownState) || {};\n    // TODO: We should try to improve our useEffect hooks to depend more on\n    // granular information instead of big objects that require deep comparison.\n    const customizer = (objValue, othValue, key) => key === 'url_params' ? true : undefined;\n    if (!isRefreshing && (\n    !_isEqualWith(formData, newFormData, customizer) ||\n    !_isEqual(ownState, filterOwnState) ||\n    isDashboardRefreshing)) {\n      setFormData(newFormData);\n      setOwnState(filterOwnState);\n      if (!hasDataSource) {\n        return;\n      }\n      setIsRefreshing(true);\n      getChartDataRequest({\n        formData: newFormData,\n        force: false,\n        requestParams: { dashboardId: 0 },\n        ownState: filterOwnState }).\n\n      then(({ response, json }) => {\n        if (isFeatureEnabled(FeatureFlag.GLOBAL_ASYNC_QUERIES)) {\n          // deal with getChartDataRequest transforming the response data\n          const result = 'result' in json ? json.result[0] : json;\n          if (response.status === 200) {\n            setIsRefreshing(false);\n            setIsLoading(false);\n            setState([result]);\n          } else\n          if (response.status === 202) {\n            waitForAsyncData(result).\n            then((asyncResult) => {\n              setIsRefreshing(false);\n              setIsLoading(false);\n              setState(asyncResult);\n            }).\n            catch((error) => {\n              setError(error.message || error.error || t('Check configuration'));\n              setIsRefreshing(false);\n              setIsLoading(false);\n            });\n          } else\n          {\n            throw new Error(`Received unexpected response status (${response.status}) while fetching chart data`);\n          }\n        } else\n        {\n          setState(json.result);\n          setError('');\n          setIsRefreshing(false);\n          setIsLoading(false);\n        }\n      }).\n      catch((error) => {\n        setError(error.statusText);\n        setIsRefreshing(false);\n        setIsLoading(false);\n      });\n    }\n  }, [\n  inViewFirstTime,\n  cascadingFilters,\n  datasetId,\n  groupby,\n  JSON.stringify(filter),\n  hasDataSource,\n  isRefreshing,\n  isDashboardRefreshing]);\n\n  useEffect(() => {\n    if ((directPathToChild == null ? void 0 : directPathToChild[0]) === filter.id) {\n      // wait for Cascade Popover to open\n      const timeout = setTimeout(() => {var _inputRef$current;\n        inputRef == null ? void 0 : (_inputRef$current = inputRef.current) == null ? void 0 : _inputRef$current.focus();\n      }, 200);\n      return () => clearTimeout(timeout);\n    }\n    return undefined;\n  }, [inputRef, directPathToChild, filter.id]);\n  const setDataMask = (dataMask) => onFilterSelectionChange(filter, dataMask);\n  const setFocusedFilter = () => dispatchFocusAction(dispatch, id);\n  const unsetFocusedFilter = () => dispatchFocusAction(dispatch);\n  if (error) {\n    return ___EmotionJSX(BasicErrorAlert, { title: t('Cannot load filter'), body: error, level: \"error\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 161, columnNumber: 17 } });\n  }\n  const isMissingRequiredValue = checkIsMissingRequiredValue(filter, (_filter$dataMask2 = filter.dataMask) == null ? void 0 : _filter$dataMask2.filterState);\n  const filterState = {\n    ...((_filter$dataMask3 = filter.dataMask) == null ? void 0 : _filter$dataMask3.filterState),\n    validateStatus: isMissingRequiredValue && 'error' };\n\n  return ___EmotionJSX(StyledDiv, { \"data-test\": \"form-item-value\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 168, columnNumber: 13 } },\n  isLoading ? ___EmotionJSX(Loading, { position: \"inline-centered\", __self: this, __source: { fileName: _jsxFileName, lineNumber: 169, columnNumber: 21 } }) : ___EmotionJSX(SuperChart, { height: HEIGHT, width: \"100%\", formData: formData\n    // For charts that don't have datasource we need workaround for empty placeholder\n    , queriesData: hasDataSource ? state : [{ data: [{}] }], chartType: filterType, behaviors: [Behavior.NATIVE_FILTER], filterState: filterState, ownState: (_filter$dataMask4 = filter.dataMask) == null ? void 0 : _filter$dataMask4.ownState, enableNoResults: metadata == null ? void 0 : metadata.enableNoResults, isRefreshing: isRefreshing, hooks: { setDataMask, setFocusedFilter, unsetFocusedFilter }, __self: this, __source: { fileName: _jsxFileName, lineNumber: 169, columnNumber: 63 } }));\n\n};__signature__(FilterValue, \"useCascadingFilters{cascadingFilters}\\nuseSelector{isDashboardRefreshing}\\nuseState{[state, setState]([])}\\nuseState{[error, setError]('')}\\nuseState{[formData, setFormData]({\\n        inView: false,\\n    })}\\nuseState{[ownState, setOwnState]({})}\\nuseState{[inViewFirstTime, setInViewFirstTime](inView)}\\nuseRef{inputRef}\\nuseState{[isLoading, setIsLoading](hasDataSource)}\\nuseState{[isRefreshing, setIsRefreshing](false)}\\nuseDispatch{dispatch}\\nuseEffect{}\\nuseEffect{}\\nuseEffect{}\", () => [useCascadingFilters, useSelector, useDispatch]);const _default =\nFilterValue;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(HEIGHT, \"HEIGHT\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterControls/FilterValue.tsx\");reactHotLoader.register(StyledDiv, \"StyledDiv\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterControls/FilterValue.tsx\");reactHotLoader.register(FilterValue, \"FilterValue\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterControls/FilterValue.tsx\");reactHotLoader.register(_default, \"default\", \"/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterControls/FilterValue.tsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/ubuntu/my_plugin/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterControls/FilterValue.tsx"],"names":[],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, { useEffect, useRef, useState } from 'react';\nimport {\n  QueryFormData,\n  SuperChart,\n  DataMask,\n  t,\n  styled,\n  Behavior,\n  ChartDataResponseResult,\n  JsonObject,\n  getChartMetadataRegistry,\n} from '@superset-ui/core';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { isEqual, isEqualWith } from 'lodash';\nimport { getChartDataRequest } from 'src/chart/chartAction';\nimport Loading from 'src/components/Loading';\nimport BasicErrorAlert from 'src/components/ErrorMessage/BasicErrorAlert';\nimport { FeatureFlag, isFeatureEnabled } from 'src/featureFlags';\nimport { waitForAsyncData } from 'src/middleware/asyncEvent';\nimport { ClientErrorObject } from 'src/utils/getClientErrorObject';\nimport { RootState } from 'src/dashboard/types';\nimport { dispatchFocusAction } from './utils';\nimport { FilterProps } from './types';\nimport { getFormData } from '../../utils';\nimport { useCascadingFilters } from './state';\nimport { checkIsMissingRequiredValue } from '../utils';\n\nconst HEIGHT = 32;\n\n// Overrides superset-ui height with min-height\nconst StyledDiv = styled.div`\n  & > div {\n    height: auto !important;\n    min-height: ${HEIGHT}px;\n  }\n`;\n\nconst FilterValue: React.FC<FilterProps> = ({\n  dataMaskSelected,\n  filter,\n  directPathToChild,\n  onFilterSelectionChange,\n  inView = true,\n}) => {\n  const { id, targets, filterType, adhoc_filters, time_range } = filter;\n  const metadata = getChartMetadataRegistry().get(filterType);\n  const cascadingFilters = useCascadingFilters(id, dataMaskSelected);\n  const isDashboardRefreshing = useSelector<RootState, boolean>(\n    state => state.dashboardState.isRefreshing,\n  );\n  const [state, setState] = useState<ChartDataResponseResult[]>([]);\n  const [error, setError] = useState<string>('');\n  const [formData, setFormData] = useState<Partial<QueryFormData>>({\n    inView: false,\n  });\n  const [ownState, setOwnState] = useState<JsonObject>({});\n  const [inViewFirstTime, setInViewFirstTime] = useState(inView);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const [target] = targets;\n  const {\n    datasetId,\n    column = {},\n  }: Partial<{ datasetId: number; column: { name?: string } }> = target;\n  const { name: groupby } = column;\n  const hasDataSource = !!datasetId;\n  const [isLoading, setIsLoading] = useState<boolean>(hasDataSource);\n  const [isRefreshing, setIsRefreshing] = useState(false);\n  const dispatch = useDispatch();\n\n  useEffect(() => {\n    if (!inViewFirstTime && inView) {\n      setInViewFirstTime(true);\n    }\n  }, [inView, inViewFirstTime, setInViewFirstTime]);\n\n  useEffect(() => {\n    if (!inViewFirstTime) {\n      return;\n    }\n    const newFormData = getFormData({\n      ...filter,\n      datasetId,\n      cascadingFilters,\n      groupby,\n      inputRef,\n      adhoc_filters,\n      time_range,\n    });\n    const filterOwnState = filter.dataMask?.ownState || {};\n    // TODO: We should try to improve our useEffect hooks to depend more on\n    // granular information instead of big objects that require deep comparison.\n    const customizer = (\n      objValue: Partial<QueryFormData>,\n      othValue: Partial<QueryFormData>,\n      key: string,\n    ) => (key === 'url_params' ? true : undefined);\n    if (\n      !isRefreshing &&\n      (!isEqualWith(formData, newFormData, customizer) ||\n        !isEqual(ownState, filterOwnState) ||\n        isDashboardRefreshing)\n    ) {\n      setFormData(newFormData);\n      setOwnState(filterOwnState);\n      if (!hasDataSource) {\n        return;\n      }\n      setIsRefreshing(true);\n      getChartDataRequest({\n        formData: newFormData,\n        force: false,\n        requestParams: { dashboardId: 0 },\n        ownState: filterOwnState,\n      })\n        .then(({ response, json }) => {\n          if (isFeatureEnabled(FeatureFlag.GLOBAL_ASYNC_QUERIES)) {\n            // deal with getChartDataRequest transforming the response data\n            const result = 'result' in json ? json.result[0] : json;\n\n            if (response.status === 200) {\n              setIsRefreshing(false);\n              setIsLoading(false);\n              setState([result]);\n            } else if (response.status === 202) {\n              waitForAsyncData(result)\n                .then((asyncResult: ChartDataResponseResult[]) => {\n                  setIsRefreshing(false);\n                  setIsLoading(false);\n                  setState(asyncResult);\n                })\n                .catch((error: ClientErrorObject) => {\n                  setError(\n                    error.message || error.error || t('Check configuration'),\n                  );\n                  setIsRefreshing(false);\n                  setIsLoading(false);\n                });\n            } else {\n              throw new Error(\n                `Received unexpected response status (${response.status}) while fetching chart data`,\n              );\n            }\n          } else {\n            setState(json.result);\n            setError('');\n            setIsRefreshing(false);\n            setIsLoading(false);\n          }\n        })\n        .catch((error: Response) => {\n          setError(error.statusText);\n          setIsRefreshing(false);\n          setIsLoading(false);\n        });\n    }\n  }, [\n    inViewFirstTime,\n    cascadingFilters,\n    datasetId,\n    groupby,\n    JSON.stringify(filter),\n    hasDataSource,\n    isRefreshing,\n    isDashboardRefreshing,\n  ]);\n\n  useEffect(() => {\n    if (directPathToChild?.[0] === filter.id) {\n      // wait for Cascade Popover to open\n      const timeout = setTimeout(() => {\n        inputRef?.current?.focus();\n      }, 200);\n      return () => clearTimeout(timeout);\n    }\n    return undefined;\n  }, [inputRef, directPathToChild, filter.id]);\n\n  const setDataMask = (dataMask: DataMask) =>\n    onFilterSelectionChange(filter, dataMask);\n\n  const setFocusedFilter = () => dispatchFocusAction(dispatch, id);\n  const unsetFocusedFilter = () => dispatchFocusAction(dispatch);\n\n  if (error) {\n    return (\n      <BasicErrorAlert\n        title={t('Cannot load filter')}\n        body={error}\n        level=\"error\"\n      />\n    );\n  }\n  const isMissingRequiredValue = checkIsMissingRequiredValue(\n    filter,\n    filter.dataMask?.filterState,\n  );\n  const filterState = {\n    ...filter.dataMask?.filterState,\n    validateStatus: isMissingRequiredValue && 'error',\n  };\n\n  return (\n    <StyledDiv data-test=\"form-item-value\">\n      {isLoading ? (\n        <Loading position=\"inline-centered\" />\n      ) : (\n        <SuperChart\n          height={HEIGHT}\n          width=\"100%\"\n          formData={formData}\n          // For charts that don't have datasource we need workaround for empty placeholder\n          queriesData={hasDataSource ? state : [{ data: [{}] }]}\n          chartType={filterType}\n          behaviors={[Behavior.NATIVE_FILTER]}\n          filterState={filterState}\n          ownState={filter.dataMask?.ownState}\n          enableNoResults={metadata?.enableNoResults}\n          isRefreshing={isRefreshing}\n          hooks={{ setDataMask, setFocusedFilter, unsetFocusedFilter }}\n        />\n      )}\n    </StyledDiv>\n  );\n};\n\nexport default FilterValue;\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}